# 1引言

## 1.1编写目的

为了开发图书馆座位预约管理系统，编写此软件需求规格说明书。

目的在于规范清晰化需求、检验需求达成度、针对性维护以及螺旋式开发。

预期的读者：

- 本项目的设计、开发、测试人员
- 本项目的客户、用户、审核人员

## 1.2背景

说明：

1. 项目名称：图书馆座位管理系统

2. 项目角色：

   | 角色       | 对象                               |
   | ---------- | ---------------------------------- |
   | 任务提出者 | 18级软件工程ZYH班Alipapa小组       |
   | 开发者     | 18级软件工程ZYH班Alipapa小组       |
   | 用户       | 西北大学师生                       |
   | 部署目标   | 多部RFID打卡机、云服务器、移动终端 |

3. 该软件系统同其他系统或其他机构的基本的相互来往关系

	- 本软件系统隶属于西北大学图书馆，是面向图书馆座位资源的管理系统。

	- 西北大学图书馆及其隶属机构、组织拥有其操作管理权限。

	- 西北大学师生为其主要服务对象，拥有其使用权限。

	- 2018级软件工程课程ZYH班Alipapa小组为其开发、维护及更新团队。负责对该软件系统的开发、维护及更新。

## 1.3定义

- RFID: (Radio Frequency IDentification)射频识别技术，用来读用户的校园卡
- 图书馆：指西北大学长安校区图书馆
- C/S架构：客户端/服务端架构
- Android：中文常译作安卓，是一个基于Linux内核的开放源代码移动操作系统
- iOS：*iOS*是由苹果公司开发的移动操作系统
- nodejs：是一个基于Chrome V8 引擎 的JavaScript 运行时
- linux：Linux，全称GNU/Linux，是一套免费使用和自由传播的类UNIX操作系统
- JDK：JDK是 Java 语言的软件开发工具包，主要用于移动设备、嵌入式设备上的java应用程序
- docker：Docker 是一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的镜像中
- MySQL：MySQL是一个关系型数据库管理系统，由瑞典*MySQL* AB 公司开发，属于 Oracle 旗下产品
- windows：MicrosoftWindows操作系统是美国微软公司研发的一套操作系统
- macOS：Mac OS是一套运行于苹果Macintosh系列电脑上的操作系统

## 1.4参考资料

### 后端

- [Java Spring框架](https://spring.io/)

- [Maven](http://maven.apache.org/)

### 前端

- [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信开发者工具](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Web_Developer_Tools.html#5)
- [npm](https://www.npmjs.com/)

# 2总体设计

## 2.1需求规定

| 输入                    | 处理                   | 输出                     |
| ----------------------- | ---------------------- | ------------------------ |
| 打卡机-用户进馆         | 更新预约状态和座位状态 | 操作状态、日志           |
| 打卡机-用户离馆         | 更新预约状态和座位状态 | 操作状态、日志           |
| 客户端-查询座位预约情况 | 查询座位情况，写入缓存 | 所有座位的预约状态、日志 |
| 客户端-绑定学号和微信号 | 写到数据库             | 操作状态、日志           |
| 客户端-登录             | 更新用户登录状态       | 返回登录信息、日志       |
| 客户端-发起预约         | 处理预约               | 预约结果、日志           |
| 客户端-查询预约         | 查找用户最近两周的预约 | 预约状态列表、日志       |

## 2.2运行环境

本系统为C/S架构，客户端运行在微信小程序平台，服务端为任意一台有公网v4地址的服务器，和一套基于RFID的打卡机。

## 2.3基本设计概念和处理流程

### 设计概念

- 预约：用户进入图书馆自习前须预约，凭预约凭证持有座位使用权。
- 进馆：用户打卡进入图书馆
- 离馆：用户打卡离开图书馆
- 暂离：用户在有限的时间内暂时离开座位，不会中断本次预约
- 违约：违反了预约机制的预约

### 机制

#### 预约机制

- 可以预约当日或第二日的座位
- 当日晚18:30开放第二日的预约资格
- 每次只能预约一个座位
- 一次预约时长为一个图书馆日以内
- 预约不能被取消
- 预约到期保留30分钟，超时记一次违约
- 每周有一次违约机会，不会被惩罚
- 暂离时间为半小时，就餐期间（11:30-13:00, 17:30-19:00）为一小时
- 若预约时长内离馆，且大于暂离时间，则记为中途离开，若在馆时间小于预约时长的80%，记一次违约
- 若预约时长内离馆，且小于暂离时间，则视为暂离，暂离时间记录在在馆时长之内

## 2.4结构

![image-20200516192424412](%E6%A6%82%E8%A6%81%E8%AE%BE%E8%AE%A1%E8%AF%B4%E6%98%8E%E4%B9%A6.assets/image-20200516192424412.png)

## 2.5人工处理过程

- 需要录入学生身份证后六位和学号之间的对应关系

# 3接口设计

## 3.1用户接口

- 绑定页：提示输入学号、身份证后6位，绑定微信
- 首页：展示楼层空闲座位数，可以选择进入相应的楼层页
- 楼层页：大致展示每个座位的预约状态，可以选择进入相应的座位信息页
- 座位信息页：详细展示每个座位的预约状态，可以发起预约
- 预约页：让用户选择预约时段，发起预约请求
- 个人信息页：展示用户信息、最近预约列表
- 预约凭证页：展示预约详细信息和状态

## 3.2外部接口

服务端对外暴露一组http接口用于打卡机系统报告用户进馆和离馆：

- `/external/user_in`
- `/external/user_out`

## 3.3内部接口

这一组接口用于小程序端和服务端进行通信，其中私有接口需要鉴权。

### 公有接口

- `/public/login`
- `/public/get_remaining_seats`
- `/public/get_level_seats`

### 私有接口

- `/private/get_reservations`
- `/private/bind_serial`
- `/private/request_reservation`


# 4运行设计

## 4.1运行模块组合

- 服务端需要安装docker

- 然后在docker虚拟子网中运行一个mysql容器、一个后端容器、一个nginx反向代理容器
- 映射物理端口80、443到反向代理容器中，由nginx解包TLS，以非TLS的形式代理后端容器
- 数据库容器不对公网暴露，仅通过虚拟子网与后端容器通信
- 后端容器和数据库容器的数据目录须挂载到本机，以便管理

若单台机器无法满足性能需求，则以上编排方式可做灵活更改。

## 4.2运行控制

完全通过容器操作来控制。详见[docker文档](https://www.docker.com/)

# 5系统数据结构设计

## 5.1逻辑结构设计要点

![image-20200517142912497](%E6%A6%82%E8%A6%81%E8%AE%BE%E8%AE%A1%E8%AF%B4%E6%98%8E%E4%B9%A6.assets/image-20200517142912497.png)

## 5.2物理结构设计要点

- mysql容器中的`/var/lib/mysql`目录须挂载到本机
- 后端容器中的`/data/lib_seat`目录须挂载到本机

## 5.3数据结构与程序的关系

- 后端容器通过socket连数据库，使用SQL操纵数据
- 前端通过http接口与后端进行通信，使用json作为交换格式